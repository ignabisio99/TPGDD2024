USE [GD1C2024]
GO

IF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'QUICK_SORT')
	EXEC('CREATE SCHEMA QUICK_SORT')
GO

IF NOT EXISTS(SELECT name FROM sys.procedures WHERE name = 'DROP_TABLES')
	EXEC('CREATE PROCEDURE [QUICK_SORT].[DROP_TABLES] AS BEGIN SET NOCOUNT ON; END');
GO

ALTER PROCEDURE [QUICK_SORT].[DROP_TABLES]
AS
BEGIN
	DECLARE @sql NVARCHAR(500) = ''
	
	DECLARE cursorTablas CURSOR FOR
	SELECT DISTINCT 'ALTER TABLE [' + tc.TABLE_SCHEMA + '].[' +  tc.TABLE_NAME + '] DROP [' + rc.CONSTRAINT_NAME + '];'
	FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS rc
	LEFT JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS tc
	ON tc.CONSTRAINT_NAME = rc.CONSTRAINT_NAME
	WHERE tc.TABLE_SCHEMA = 'QUICK_SORT'

	OPEN cursorTablas
	FETCH NEXT FROM cursorTablas INTO @sql

	WHILE (@@FETCH_STATUS = 0)
	BEGIN
		EXEC sp_executesql @sql
		FETCH NEXT FROM cursorTablas INTO @Sql
	END

	CLOSE cursorTablas
	DEALLOCATE cursorTablas
	
	EXEC sp_MSforeachtable 'DROP TABLE ?', @whereand='AND schema_name(schema_id) = ''QUICK_SORT'' AND o.name NOT LIKE ''BI_%'''
END
GO

EXEC [QUICK_SORT].[DROP_TABLES]
GO

IF NOT EXISTS(SELECT name FROM sys.procedures WHERE name='CREATE_TABLES')
   EXEC('CREATE PROCEDURE [QUICK_SORT].[CREATE_TABLES] AS BEGIN SET NOCOUNT ON; END');
GO

ALTER PROCEDURE [QUICK_SORT].[CREATE_TABLES]
AS
BEGIN
		CREATE TABLE [QUICK_SORT].PRODUCTO_CATEGORIA(
			PRODUCTO_CATEGORIA_ID INTEGER IDENTITY(1,1) PRIMARY KEY,
			PRODUCTO_CATEGORIA NVARCHAR(255)
		);

		CREATE TABLE [QUICK_SORT].PRODUCTO_SUB_CATEGORIA(
			PRODUCTO_SUB_CATEGORIA_ID INTEGER IDENTITY(1,1) PRIMARY KEY,
			PRODUCTO_CATEGORIA_ID INTEGER REFERENCES[QUICK_SORT].[PRODUCTO_CATEGORIA],
			PRODUCTO_SUB_CATEGORIA NVARCHAR(255)
		);

		CREATE TABLE [QUICK_SORT].[PRODUCTO](
			PRODUCTO_ID INTEGER IDENTITY(1,1) PRIMARY KEY,
			PRODUCTO_SUB_CATEGORIA_ID INTEGER REFERENCES[QUICK_SORT].[PRODUCTO_SUB_CATEGORIA],
			PRODUCTO_NOMBRE NVARCHAR(255),
			PRODUCTO_DESCRIPCION NVARCHAR(255),
			PRODUCTO_PRECIO DECIMAL(18,2),
			PRODUCTO_MARCA NVARCHAR(255)
		);

		CREATE TABLE [QUICK_SORT].PROMOCION(
			PROMO_CODIGO DECIMAL(18,0)  PRIMARY KEY,
        	PROMO_DESCRIPCION NVARCHAR(255),
        	PROMO_FECHA_INICIO DATETIME,
        	PROMO_FECHA_FIN DATETIME

		);

		CREATE TABLE [QUICK_SORT].REGLA_PROMOCION_PRODUCTO(
			PROMO_CODIGO DECIMAL(18,0) REFERENCES [QUICK_SORT].[PROMOCION],
        	PRODUCTO_ID INTEGER REFERENCES [QUICK_SORT].[PRODUCTO],
        	PRIMARY KEY (PROMO_CODIGO, PRODUCTO_ID)
		);


		CREATE TABLE [QUICK_SORT].REGLA_PROMOCION(
			REGLA_PROMOCION_ID INTEGER IDENTITY(1,1) PRIMARY KEY,
			REGLA_PROMO_CODIGO DECIMAL(18,0) REFERENCES [QUICK_SORT].[PROMOCION],
			REGLA_DESCRIPCION NVARCHAR(255),
			REGLA_DESCUENTO_APLICABLE DECIMAL(18,2),
			REGLA_CANTIDAD_APLICABLE DECIMAL(18,0),
			REGLA_CANTIDAD_APLICABLE_DESCUENTO DECIMAL(18,0),
			REGLA_CANTIDAD_MAXIMA DECIMAL(18,0),
			REGLA_APLICA_MISMA_MARCA DECIMAL (18,0),
			REGLA_APLICA_MISMO_PRODUCTO DECIMAL (18,0)
		);

		CREATE TABLE [QUICK_SORT].DETALLE_POR_PROMOCION(
		--TODO  
			PROMO_CODIGO DECIMAL(18,0) REFERENCES [QUICK_SORT].[PROMOCION],
			DETALLE_TICKET_ID INTEGER IDENTITY(1,1),
			PROMO_TOTAL DECIMAL(18,2),
			PRIMARY KEY (DETALLE_TICKET_ID,PROMO_CODIGO)
		);

END
GO
-- Ejecutar procedimiento para crear tablas
EXEC [QUICK_SORT].[CREATE_TABLES]
GO

CREATE PROCEDURE [QUICK_SORT].[MIGRAR]
AS
BEGIN

INSERT INTO [QUICK_SORT].[PRODUCTO_CATEGORIA] (PRODUCTO_CATEGORIA)
	SELECT DISTINCT PRODUCTO_CATEGORIA
	FROM [gd_esquema].[Maestra]
	WHERE PRODUCTO_CATEGORIA IS NOT NULL

INSERT INTO [QUICK_SORT].[PRODUCTO_SUB_CATEGORIA] (PRODUCTO_CATEGORIA_ID,PRODUCTO_SUB_CATEGORIA)
	SELECT DISTINCT p.PRODUCTO_CATEGORIA_ID,m.PRODUCTO_SUB_CATEGORIA
	FROM [gd_esquema].[Maestra] m JOIN [QUICK_SORT].[PRODUCTO_CATEGORIA] p ON  p.PRODUCTO_CATEGORIA = m.PRODUCTO_CATEGORIA
	WHERE PRODUCTO_SUB_CATEGORIA IS NOT NULL


INSERT INTO [QUICK_SORT].[PRODUCTO]( PRODUCTO_SUB_CATEGORIA_ID, PRODUCTO_NOMBRE, PRODUCTO_DESCRIPCION, PRODUCTO_PRECIO, PRODUCTO_MARCA)
	SELECT DISTINCT p.PRODUCTO_SUB_CATEGORIA_ID,PRODUCTO_NOMBRE, PRODUCTO_DESCRIPCION, PRODUCTO_PRECIO, PRODUCTO_MARCA 
	FROM [gd_esquema].[Maestra] m JOIN [QUICK_SORT].[PRODUCTO_SUB_CATEGORIA] p ON p.PRODUCTO_SUB_CATEGORIA = m.PRODUCTO_SUB_CATEGORIA
	WHERE PRODUCTO_NOMBRE IS NOT NULL
	AND PRODUCTO_DESCRIPCION IS NOT NULL
	AND PRODUCTO_PRECIO IS NOT NULL
	AND PRODUCTO_MARCA IS NOT NULL


INSERT INTO [QUICK_SORT].[PROMOCION] (PROMO_CODIGO,PROMO_DESCRIPCION, PROMO_FECHA_INICIO, PROMO_FECHA_FIN)
	SELECT DISTINCT PROMO_CODIGO,PROMOCION_DESCRIPCION,PROMOCION_FECHA_FIN,
	PROMOCION_FECHA_INICIO
	FROM [gd_esquema].[Maestra]
	WHERE PROMO_CODIGO IS NOT NULL

INSERT INTO [QUICK_SORT].[REGLA_PROMOCION_PRODUCTO] (PROMO_CODIGO,PRODUCTO_ID)
	SELECT DISTINCT p.PROMO_CODIGO, pr.PRODUCTO_ID
	FROM [gd_esquema].[Maestra] m
	JOIN [QUICK_SORT].[PROMOCION] p ON p.PROMO_CODIGO = m.PROMO_CODIGO
	JOIN [QUICK_SORT].[PRODUCTO] pr ON pr.PRODUCTO_NOMBRE = m.PRODUCTO_NOMBRE AND pr.PRODUCTO_DESCRIPCION = m.PRODUCTO_DESCRIPCION AND pr.PRODUCTO_PRECIO = m.PRODUCTO_PRECIO AND pr.PRODUCTO_MARCA = m.PRODUCTO_MARCA
	WHERE m.PROMO_CODIGO IS NOT NULL 

INSERT INTO [QUICK_SORT].[REGLA_PROMOCION] (REGLA_PROMO_CODIGO,REGLA_DESCRIPCION,REGLA_DESCUENTO_APLICABLE,REGLA_CANTIDAD_APLICABLE,REGLA_CANTIDAD_APLICABLE_DESCUENTO,REGLA_CANTIDAD_MAXIMA,REGLA_APLICA_MISMA_MARCA,REGLA_APLICA_MISMO_PRODUCTO)
	SELECT DISTINCT p.PROMO_CODIGO,m.REGLA_DESCRIPCION,m.REGLA_DESCUENTO_APLICABLE_PROD,m.REGLA_CANT_APLICABLE_REGLA,m.REGLA_CANT_APLICA_DESCUENTO,m.REGLA_CANT_MAX_PROD,m.REGLA_APLICA_MISMA_MARCA,m.REGLA_APLICA_MISMO_PROD
	FROM [gd_esquema].[Maestra] m JOIN [QUICK_SORT].[PROMOCION] p ON p.PROMO_CODIGO = m.PROMO_CODIGO
	WHERE m.PROMO_CODIGO IS NOT NULL
	AND REGLA_DESCRIPCION IS NOT NULL
	AND REGLA_DESCUENTO_APLICABLE_PROD IS NOT NULL
	AND REGLA_CANT_APLICABLE_REGLA IS NOT NULL
	AND REGLA_CANT_APLICA_DESCUENTO IS NOT NULL
	AND REGLA_CANT_MAX_PROD IS NOT NULL
	AND REGLA_APLICA_MISMA_MARCA IS NOT NULL
	AND REGLA_APLICA_MISMO_PROD IS NOT NULL

--TODO	
INSERT INTO [QUICK_SORT].[DETALLE_POR_PROMOCION] (DETALLE_TICKET_ID,PROMO_CODIGO,PROMO_TOTAL)
	SELECT DISTINCT d.DETALLE_TICKET_ID,p.PROMO_CODIGO,m.PROMO_APLICADA_DESCUENTO
	FROM [gd_esquema].[Maestra] m
	 JOIN [QUICK_SORT].[PROMOCION] p ON p.PROMO_CODIGO = m.PROMO_CODIGO
	 JOIN [QUICK_SORT].[PRODUCTO] pr ON pr.PRODUCTO_NOMBRE = m.PRODUCTO_NOMBRE AND pr.PRODUCTO_DESCRIPCION = m.PRODUCTO_DESCRIPCION AND pr.PRODUCTO_PRECIO = m.PRODUCTO_PRECIO AND pr.PRODUCTO_MARCA = m.PRODUCTO_MARCA
	JOIN [QUICK_SORT].[TICKET] t ON t.TICKET_NRO = m.TICKET_NUMERO and t.TICKET_FECHA_HORA = m.TICKET_FECHA_HORA and t.TICKET_SUBTOTAL_PRODUCTOS = m.TICKET_SUBTOTAL_PRODUCTOS
	JOIN [QUICK_SORT].[DETALLE_TICKET] d ON d.DETALLE_TICKET_TICKET_ID = t.TICKET_ID and d.PRODUCTO_ID = pr.PRODUCTO_ID
	
	 --LINKEAR POR PRODUCTO Y TICKET
	  
	 


INSERT INTO [QUICK_SORT].[REGLA_PROMOCION_PRODUCTO] (PROMO_CODIGO,PRODUCTO_ID)
	SELECT DISTINCT p.PROMO_CODIGO, pr.PRODUCTO_ID
	FROM [gd_esquema].[Maestra] m
	JOIN [QUICK_SORT].[PROMOCION] p ON p.PROMO_CODIGO = m.PROMO_CODIGO
	JOIN [QUICK_SORT].[PRODUCTO] pr ON pr.PRODUCTO_NOMBRE = m.PRODUCTO_NOMBRE AND pr.PRODUCTO_DESCRIPCION = m.PRODUCTO_DESCRIPCION AND pr.PRODUCTO_PRECIO = m.PRODUCTO_PRECIO AND pr.PRODUCTO_MARCA = m.PRODUCTO_MARCA
	WHERE m.PROMO_CODIGO IS NOT NULL 

END
GO

EXEC [QUICK_SORT].[MIGRAR]

GO

